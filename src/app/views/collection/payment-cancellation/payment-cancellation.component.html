<div class="card container-fluid">
    <form [formGroup]="groupReceiptsForm" >
        <div class="text-center">
            <h1>Normalización de Pagos</h1>
        </div>

        <mat-tab-group>
          <!-- recibos notificados -->
          <mat-tab label="Recibos notificados"> 
            <div class="p-4">
              <h2>Total Notificado {{totalNotificated}} $</h2>
            </div>

            <div>
              <button class="btn btn-primary rounded-pill p-3" type="button" [disabled]="!GroupReceiptsBool" >Cobrar notificaciones agrupadas</button>
            </div>

            <div class="mat-elevation-z8 mt-5" formArrayName="agrupado" >

              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Cedula de Identidad</th>
                    <th scope="col">Fecha de notificacion de pago</th>
                    <th scope="col">Tasa BCV</th>
                    <th scope="col">Pago declarado Bs</th>
                    <th scope="col">Pago declarado $</th>
                    <th scope="col">Validar Recibos</th>

                  </tr>
                </thead>
                <tbody *ngFor="let creds of agrupado.value; let i=index">
                  <tr [formGroupName]="i">
                    <th (click)="dataNotification(creds.ctransaccion)">{{creds.casegurado}}</th>
                    <td (click)="dataNotification(creds.ctransaccion)">{{creds.freporte}}</td>
                    <td (click)="dataNotification(creds.ctransaccion)">{{creds.ptasamon}}</td>
                    <td (click)="dataNotification(creds.ctransaccion)">{{creds.mpago}}</td>
                    <td (click)="dataNotification(creds.ctransaccion)">{{creds.mpagoext}}</td>
                    <td>
                      <mat-checkbox class="example-margin" formControlName="agrupador" (change)="GroupReceipt()"></mat-checkbox>
                    </td>
                  </tr>

                </tbody>
              </table>

            </div>
          </mat-tab>

          <mat-tab label="Recibos Pendientes"> 

            <div class="p-4">
              <h2>Total Pendiente {{totalPending}} $</h2>
              <button class="btn btn-primary rounded-pill p-3" type="button" (click)="downloadExcel()"><strong>Descargar recibos pendientes</strong></button>
              <button class="btn btn-primary rounded-pill p-3" type="button" (click)="downloadExcelVencido()"><strong>Descargar recibos vencidos</strong></button>

            </div>

            

            <mat-form-field>
              <mat-label>Datos</mat-label>
              <input matInput (keyup)="applyFilter2($event)" placeholder="Datos de busqueda" #input>
            </mat-form-field>
            
            <div class="mat-elevation-z8">
              <table mat-table [dataSource]="dataSource2" #table2Sort matSort >
            
                <!-- ID Column -->
                <ng-container matColumnDef="poliza">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Poliza</th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.cpoliza}} </td>
                </ng-container>
            
                <!-- Progress Column -->
                <ng-container matColumnDef="recibo">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Recibo</th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.crecibo}} </td>
                </ng-container>

                <!-- Progress Column -->
                <ng-container matColumnDef="cuota">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Cuota </th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.qcuotas}} </td>
                </ng-container>
            
                <!-- Name Column -->
                <ng-container matColumnDef="ramo">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Ramo </th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.cramo}} </td>
                </ng-container>
            
                <!-- Fruit Column -->
                <ng-container matColumnDef="asegurado">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Asegurado </th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.casegurado}} </td>
                </ng-container>

                <!-- Fruit Column -->
                <ng-container matColumnDef="mount">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Prima BS </th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.mprimabruta}} </td>
                </ng-container>

                <!-- Fruit Column -->
                <ng-container matColumnDef="mountBs">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Prima Dolares </th>
                  <td mat-cell *matCellDef="let row" (click)="dataPendient(row.crecibo,row.casegurado)"> {{row.mprimabrutaext}} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns2"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns2;"></tr>
            
                <!-- Row shown when there is no matching data. -->
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell" colspan="4">No data matching the filter "{{input.value}}"</td>
                </tr>
              </table>
            
              <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" [pageSize]="5"  aria-label="Select page of users" #table2Paginator></mat-paginator>
            </div>
          </mat-tab>

        </mat-tab-group>

        <ng-template #Alerta >
          <mat-dialog-content  >
            
            <form action=""  [formGroup]="updateReceiptPending">
              <div class="container-fluid">
                <h1 class="text-center">Registro de pago</h1>
                <div class="row">
                  <div class="col-3">
                    <h2>Tasa del dia {{bcv}} Bs</h2>

                    <strong>Cliente</strong>   {{cliente}}<br>
                    <strong>Correo</strong>    {{correo}}<br>
                    <strong>Telefono</strong>  {{telefono}}<br>
                  </div>


                  <div class="row col-8" *ngFor="let data of dataReceiptPending let i=index">
                    <h2 class="text-center">Datos del recibo</h2>

                    <div class="col">
                      <strong>Moneda</strong>  {{data.cmoneda}} <br>
                      <strong>Recibo</strong>  {{data.crecibo}} <br>
                      <strong>Poliza </strong> {{data.cpoliza}}

                    </div>
                    <div class="col">
                      <strong>Fecha desde recibo</strong> {{data.fdesde}} <br>
                      <strong>Fecha hasta recibo</strong> {{data.fhasta}} <br>
                      <strong>N° Cuota</strong>  {{data.qcuotas}} <br>

                    </div>
                    <div class="col">
                      <strong>Prima $</strong> {{data.mprimabrutaext}} <br>
                      <strong>Prima Bs</strong> {{data.mprimabruta}} <br>
                      <strong>Ramo</strong> {{data.cramo}}

                    </div>
 
                  </div>

                </div>    
                <div class="row mt-3">
                  <div class="col-2">
                    <mat-radio-group aria-label="Select an option" formControlName="itransaccion" (change)="validationOperation()">
                      <mat-radio-button value="PM">Pago Movil</mat-radio-button>
                      <mat-radio-button value="EF">Efectivo</mat-radio-button>
                      <mat-radio-button value="TR">Tranferencia</mat-radio-button>
                      <mat-radio-button value="PS">Pasarela</mat-radio-button>
                      <mat-radio-button value="DP">Deposito</mat-radio-button>
                    </mat-radio-group>
                  </div>

                  <div class="col-4 row ">

                    <mat-form-field>
                      <mat-label>Moneda</mat-label>
                      <mat-select formControlName="cmoneda">
                        <mat-option  *ngFor="let data of coinList let i=index" value="{{data.id}}">{{data.value}}</mat-option>
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label>Banco Destino</mat-label>
                      <mat-select formControlName="cbanco_destino" >
                        <mat-option *ngFor="let data of bankReceptorInternational let i=index" value="{{data.id}}">{{data.value}}</mat-option>
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label>Banco Remitente</mat-label>
                      <mat-select formControlName="cbanco">
                        <mat-option  *ngFor="let data of bankInternational let i=index" value="{{data.id}}">{{data.value}}</mat-option>
                      </mat-select>
                    </mat-form-field>


                    <!-- <mat-form-field>
                      <mat-label>Banco Destino</mat-label>
                      <mat-select formControlName="cbanco_destino" >
                        <mat-option *ngFor="let data of bankReceptorNational let i=index" value="{{data.id}}">{{data.value}}</mat-option>
                      </mat-select>
                    </mat-form-field> -->

                    <!-- <mat-form-field>
                      <mat-label>Banco Remitente</mat-label>
                      <mat-select formControlName="cbanco" >
                        <mat-option  *ngFor="let data of bankNational let i=index" value="{{data.id}}">{{data.value}}</mat-option>
                      </mat-select>
                    </mat-form-field> -->
                  </div>

                  <div class="col-4 row ">

                    <mat-form-field >
                      <mat-label>Monto pagado</mat-label>
                      <input matInput  formControlName="mpago">
                    </mat-form-field>


                    <mat-form-field >
                      <mat-label>Referencia bancaria</mat-label>
                      <input matInput  formControlName="xreferencia">
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label>Estado de recibo</mat-label>
                      <mat-select formControlName="iestadorec">
                        <mat-option value="C">Cobrado</mat-option>
                        <mat-option value="R">En revision</mat-option>
                      </mat-select>
                    </mat-form-field>

                  </div>
                  <div class="form-outline" >
                    <label for="">Carga de referencia </label>
                    <input type="file"  accept="image/png, image/jpeg, image/jpg" class="form-control rounded-input mt-3" name="ximagen" formControlName="ximagen" (change)="onFileSelect($event)" #Ximagen>
                  </div>
                </div>
                <button mat-button (click)="saveUpdateReceiptPending()">Cobrar recibo</button>
              </div>

            </form>

          </mat-dialog-content>
        </ng-template>

        <ng-template #Pending >
          <mat-dialog-content  >

            <form action="" [formGroup]="updateReceipt">
              <div class="container-fluid row" >

                <div  class="col-4" *ngFor="let data of dataReport let i=index">
                  <h2>Datos del recibo notificado</h2>
                  <p><strong>Poliza: </strong> {{data.cpoliza}}</p>
                  <p><strong>Recibo: </strong> {{data.crecibo}}</p>
                  <p><strong>Asegurado: </strong> {{data.casegurado}}</p>
                  <p><strong>Ramo: </strong> {{data.cramo}}</p>
                  <p><strong>Prima $: </strong> {{data.mprimabrutaext}}</p>
                  <p><strong>Prima Bs: </strong> {{data.mprimabruta}}</p>
                </div>
  
                <div *ngFor="let data of dataSoport let i=index" class="row">
                  <h2 class="text-center"><strong>Soporte de pago</strong></h2>
                  <div class="col-4" >
                    <p><strong>Banco remitente: </strong> {{data.cbanco}}</p>
                    <p><strong>Banco destino: </strong> {{data.cbanco_destino}}</p>
                    <p><strong>Moneda: </strong> {{data.cmoneda}}</p>
                    <p><strong>Pago Bs: </strong> {{data.mpago}}</p>
                    <p><strong>Pago $: </strong> {{data.mpagoext}}</p>
                  </div>
                  <div class="col-4" >
                    <p><strong>IGTF Bs: </strong> {{data.mpagoigtf}}</p>
                    <p><strong>IGTF: </strong> {{data.mpagoigtfext}}</p>
                    <p><strong>Tasa: </strong> {{data.ptasamon}}</p>
                    <p><strong>Tasa referencial: </strong> {{data.ptasaref}}</p>
                    <p><strong>Referencia : </strong> {{data.xreferencia}}</p>
                  </div>
                  <div class="col-4">
                    <img [src]="urlImg" alt="" class="img-fluid">
                  </div>
  
                </div>
  
              </div> 
  
              <div class="row">
                <h2>Seleccione la forma en la que el pago fue registrado</h2>
                <div class="col-4">
                  <mat-radio-group aria-label="Select an option" formControlName="itransaccion">
                    <mat-radio-button value="PM">Pago Movil</mat-radio-button>
                    <mat-radio-button value="EF">Efectivo</mat-radio-button>
                    <mat-radio-button value="TR">Tranferencia</mat-radio-button>
                    <mat-radio-button value="PS">Pasarela</mat-radio-button>
                    <mat-radio-button value="DP">Deposito</mat-radio-button>
                  </mat-radio-group>
                </div>
  
  
                <div class="col-4">
                  <mat-form-field>
                    <mat-label>Estado de recibo</mat-label>
                    <mat-select formControlName="iestadorec">
                      <mat-option value="C">Cobrado</mat-option>
                      <mat-option value="R">En revision</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
  
                <button mat-button (click)="updateReceiptNotificated()">Actualizar recibo</button>
              </div>
            </form>

          </mat-dialog-content>
        </ng-template>


    </form>

</div>
